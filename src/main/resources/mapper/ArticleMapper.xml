<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.Zewang.myBlog.dao.ArticleMapper">

  <resultMap id="BaseResultMap" type="org.Zewang.myBlog.model.Article">
    <id column="id" property="id" jdbcType="BIGINT"/>
    <result column="title" property="title" jdbcType="VARCHAR"/>
    <result column="content" property="content" jdbcType="LONGVARCHAR"/>
    <result column="author" property="author" jdbcType="VARCHAR"/>
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    <result column="status" property="status" typeHandler="org.apache.ibatis.type.EnumOrdinalTypeHandler"/>
  </resultMap>

  <sql id="Base_Column_List">
    id, title, content, author, create_time, update_time, status
  </sql>

  <select id="findAll" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM article
    ORDER BY create_time DESC
  </select>

  <select id="findById" resultMap="BaseResultMap" parameterType="java.lang.Long">
    SELECT
    <include refid="Base_Column_List"/>
    FROM article
    WHERE id = #{id,jdbcType=BIGINT}
  </select>
  
  <select id="findByCategoryId" resultMap="BaseResultMap" parameterType="java.lang.Long">
    SELECT 
      a.id, a.title, a.content, a.author, a.create_time, a.update_time, a.status
    FROM article a
    JOIN article_category ac ON a.id = ac.article_id
    WHERE ac.category_id = #{categoryId,jdbcType=BIGINT}
    ORDER BY a.create_time DESC
  </select>

  <insert id="insert" parameterType="org.Zewang.myBlog.model.Article" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO article
      (title, content, author, create_time, update_time, status)
    VALUES
      (#{title,jdbcType=VARCHAR},
       #{content,jdbcType=LONGVARCHAR},
       #{author,jdbcType=VARCHAR},
       #{createTime,jdbcType=TIMESTAMP},
       #{updateTime,jdbcType=TIMESTAMP},
       #{status,jdbcType=INTEGER,typeHandler=org.apache.ibatis.type.EnumOrdinalTypeHandler})
  </insert>

  <update id="update" parameterType="org.Zewang.myBlog.model.Article">
    UPDATE article
    <set>
      <if test="title != null">title = #{title,jdbcType=VARCHAR},</if>
      <if test="content != null">content = #{content,jdbcType=LONGVARCHAR},</if>
      <if test="author != null">author = #{author,jdbcType=VARCHAR},</if>
      <if test="updateTime != null">update_time = #{updateTime,jdbcType=TIMESTAMP},</if>
      <if test="status != null">status = #{status,jdbcType=INTEGER,typeHandler=org.apache.ibatis.type.EnumOrdinalTypeHandler},</if>
    </set>
    WHERE id = #{id,jdbcType=BIGINT}
  </update>

  <delete id="deleteById" parameterType="java.lang.Long">
    DELETE FROM article
    WHERE id = #{id,jdbcType=BIGINT}
  </delete>

  <select id="existsById" resultType="boolean">
    SELECT COUNT(1) > 0
    FROM article
    WHERE id = #{id,jdbcType=BIGINT}
  </select>

  <select id="existsByTitle" resultType="boolean">
    SELECT COUNT(1) > 0
    FROM article
    WHERE title = #{title,jdbcType=VARCHAR}
  </select>

  <select id="existsByTitleAndIdNot" resultType="boolean">
    SELECT COUNT(1) > 0
    FROM article
    WHERE title = #{title,jdbcType=VARCHAR} AND id != #{id,jdbcType=BIGINT}
  </select>

</mapper>